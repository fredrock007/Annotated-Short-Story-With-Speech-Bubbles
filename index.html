<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Short Story + Hidden Neon Snake (SA Edition)</title>
<style>
  /* ---------------- Core Theme ---------------- */
  :root{
    --bg:#0f172a; --panel:#0b1220; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#38bdf8; --accent-2:#a78bfa; --accent-3:#34d399; --warning:#f59e0b;
    --sa-green:#007a4d; --sa-gold:#ffb612; --sa-red:#de3831; --sa-blue:#002395; --sa-black:#000; --sa-white:#fff;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    background:
      radial-gradient(1000px 600px at 10% -10%, rgba(56,189,248,.15), transparent 60%),
      radial-gradient(800px 500px at 90% 0%, rgba(167,139,250,.12), transparent 60%),
      var(--bg);
    color:var(--ink);
    line-height:1.6;
  }
  .wrap{max-width:1000px; margin:24px auto 56px; padding:0 16px;}
  .header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin:18px 0 8px}
  .title{font-size: clamp(22px, 3vw, 34px); font-weight:800; margin:0}
  .badge{font-size:12px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted);}

  /* -------------- Banner with SA Flag (emoji) -------------- */
  .banner{display:flex; align-items:center; gap:14px; padding:12px 14px; border:1px solid #233047;
          background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border-radius:16px}
  .flag-cta{display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; position:relative}
  .flag-emoji{font-size:38px; filter:drop-shadow(0 2px 0 rgba(0,0,0,.4))}
  .click-me{position:absolute; top:-10px; left:36px; font-weight:900; font-size:12px; background:var(--sa-gold);
            color:#051514; padding:2px 6px; border-radius:999px; box-shadow:0 2px 8px rgba(0,0,0,.35)}
  .shake { animation: shake 1.6s ease-in-out infinite; transform-origin:center }
  @keyframes shake{
    0%,100% { transform: rotate(0deg) }
    10% { transform: rotate(-6deg) }
    20% { transform: rotate(5deg) }
    30% { transform: rotate(-4deg) }
    40% { transform: rotate(3deg) }
    50% { transform: rotate(-2deg) }
    60% { transform: rotate(2deg) }
    70% { transform: rotate(-1deg) }
    80% { transform: rotate(1deg) }
    90% { transform: rotate(-.5deg) }
  }

  /* -------------- Controls for Story Annotations -------------- */
  .controls{display:flex; gap:12px; flex-wrap:wrap; margin:14px 0 22px}
  button{background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#041016; border:0; padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer}
  button.secondary{background:#1f2937; color:var(--ink); border:1px solid #334155}

  /* -------------- Story + Bubbles (unchanged logic; initial hidden) -------------- */
  .story{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid #233047; border-radius:20px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .line{display:grid; grid-template-columns: 1fr minmax(260px, 32%); gap:18px; align-items:start; padding:16px 12px; border-radius:14px; position:relative}
  .line + .line{border-top:2px solid rgba(99,102,241,.35); box-shadow: 0 -6px 18px -12px rgba(99,102,241,.45) inset}
  .line{background: rgba(2,6,23,.45)}
  .line:nth-of-type(even){background: rgba(2,6,23,.62)}
  .line .text{padding:12px; border-radius:12px}
  .line.scene .text{background: linear-gradient(135deg, rgba(34,211,238,.10), rgba(14,165,233,.08)); border-left:4px solid rgba(14,165,233,.7)}
  .line.suspense .text{background: linear-gradient(135deg, rgba(245,158,11,.12), rgba(239,68,68,.08)); border-left:4px solid rgba(239,68,68,.7)}
  .line.lang .text{background: linear-gradient(135deg, rgba(167,139,250,.12), rgba(99,102,241,.08)); border-left:4px solid rgba(99,102,241,.7)}
  .line.seq .text{background: linear-gradient(135deg, rgba(52,211,153,.12), rgba(16,185,129,.08)); border-left:4px solid rgba(16,185,129,.7)}
  .text p{margin:0; font-size: clamp(16px, 2vw, 18px)}
  .text mark{background: rgba(56,189,248,.18); color:#eaf7ff; padding:0 .2em; border-radius:4px}

  .bubble{position:relative; background:#101827; border:1px solid #233047; border-radius:16px; padding:14px; color:#dbebff; transition:transform .2s ease,box-shadow .2s ease}
  .bubble:before{content:""; position:absolute; left:-10px; top:18px; border-width:10px; border-style:solid; border-color:transparent #233047 transparent transparent}
  .bubble:after{content:""; position:absolute; left:-8px; top:20px; border-width:9px; border-style:solid; border-color:transparent #101827 transparent transparent}
  .bubble:hover{transform: translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.35)}
  .bubble.scene-b{background:linear-gradient(135deg, rgba(34,211,238,.18), rgba(14,165,233,.18)), #0b1220; border-color:rgba(14,165,233,.6)}
  .bubble.suspense-b{background:linear-gradient(135deg, rgba(245,158,11,.2), rgba(239,68,68,.18)), #0b1220; border-color:rgba(239,68,68,.6)}
  .bubble.lang-b{background:linear-gradient(135deg, rgba(167,139,250,.22), rgba(99,102,241,.18)), #0b1220; border-color:rgba(99,102,241,.6)}
  .bubble.seq-b{background:linear-gradient(135deg, rgba(52,211,153,.22), rgba(16,185,129,.18)), #0b1220; border-color:rgba(16,185,129,.6)}
  .tag{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; margin-right:6px; color:#041016; font-weight:800}
  .tag.scene{background:#22d3ee}.tag.suspense{background:#f59e0b}.tag.lang{background:#a78bfa}.tag.seq{background:#34d399}
  .hidden-annotations .bubble{display:none}

  /* -------------- Snake Modal -------------- */
  dialog#snakeModal{border:0; padding:0; border-radius:18px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); color:var(--ink); width:min(980px, 96vw)}
  .modal-wrap{display:grid; grid-template-columns: 1fr 260px; gap:12px; padding:14px; border:1px solid #1f2a44; border-radius:18px; background:#0b1220}
  .game-surface{position:relative; border-radius:16px; background: radial-gradient(800px 400px at 50% 0%, rgba(0,122,77,.18), transparent 60%), #0e1324; border:1px solid #1b2744; min-height:420px; display:flex; align-items:center; justify-content:center; overflow:hidden}
  canvas#game3d, canvas#game2d{display:block; width:100%; height:100%}
  .hud{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid #1f2a44; border-radius:12px; background:#0e1729; margin-bottom:10px}
  .pill{background:#0c3b2e; color:#caffda; padding:4px 10px; border-radius:999px; font-weight:800}
  .neon{font-weight:800; letter-spacing:.02em; text-shadow:0 0 6px rgba(255,255,255,.22), 0 0 10px rgba(0,122,77,.35)}
  .side{display:flex; flex-direction:column; gap:10px}
  .ctrl-grid{display:grid; grid-template-columns: repeat(3, 72px); gap:8px; place-items:center; justify-content:center; margin-top:6px}
  .ctrl-btn{width:72px; height:72px; border-radius:16px; border:1px solid #264766; background:linear-gradient(180deg, #16324a, #0e253a); color:#eaf7ff; font-size:22px; font-weight:900}
  .ctrl-btn:active{transform:scale(.97)}
  .row-gap{height:0}
  .legend-chip{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
  .legend-chip i{display:inline-block; width:10px; height:10px; border-radius:999px}
  .i-green{background:var(--sa-green)} .i-gold{background:var(--sa-gold)} .i-red{background:var(--sa-red)} .i-blue{background:var(--sa-blue)}
  .bar{height:1px; background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent); margin:6px 0}

  .modal-actions{display:flex; gap:8px; justify-content:flex-end}
  .ghost{background:#1f2937; color:var(--ink); border:1px solid #334155}

  /* In-game milestone reminder */
  .reminder{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter: blur(2px)}
  .reminder-card{max-width:520px; background:#0e1729; border:1px solid #29527a; border-radius:16px; padding:16px; text-align:center; box-shadow:0 14px 40px rgba(0,0,0,.5)}
  .reminder-card h3{margin:2px 0 6px}
  .reminder-card p{margin:0 0 10px}
  .reminder .ok{background:linear-gradient(135deg, var(--sa-gold), #ffd36b); color:#1c1100}

  /* Layout tweaks for tablets (Lenovo TB328XU) */
  @media (max-width: 900px){
    .modal-wrap{grid-template-columns: 1fr}
    .ctrl-grid{grid-template-columns: repeat(3, 64px)}
    .ctrl-btn{width:64px; height:64px}
  }
  @media (max-width: 820px){
    .line{grid-template-columns: 1fr; gap:10px}
    .bubble:before,.bubble:after{left:20px; top:-10px; transform:rotate(90deg)}
    .bubble{padding-top:18px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="badge">See It · Grade 10 · Storytelling</div>
        <h1 class="title">Short Story with Annotations (Speech Bubbles)</h1>
      </div>

      <!-- Banner with SA flag emoji that shakes -->
      <div class="banner" aria-label="Hidden game banner">
        <div id="flagCta" class="flag-cta" role="button" tabindex="0" title="Hidden Neon Snake">
          <span class="flag-emoji shake" aria-hidden="true">🇿🇦</span>
          <span class="click-me">Click me</span>
          <span class="badge" style="margin-left:58px">Neon Snake · South African Colours</span>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="toggleAll" aria-pressed="false">Show Annotations</button>
    </div>

    <!-- STORY (initially hidden annotations) -->
    <section class="story hidden-annotations" id="story">
      <!-- LINE 1 -->
      <div class="line scene">
        <div class="text">
          <p>The corridor was <mark>unusually quiet</mark> as Lebo walked towards the library.</p>
        </div>
        <aside class="bubble scene-b">
          <span class="tag scene">Scene</span>
          The word <em>"unusually"</em> hints that something is off. It sets the mood before anything happens.
          <small>Skill: establishing atmosphere</small>
        </aside>
      </div>
      <!-- LINE 2 -->
      <div class="line lang">
        <div class="text">
          <p>The <mark>flickering fluorescent lights</mark> cast long shadows on the walls, and the sound of her footsteps <mark>echoed</mark> against the tiled floor.</p>
        </div>
        <aside class="bubble lang-b">
          <span class="tag lang">Language</span>
          Imagery (flickering, long shadows, echoed) creates an eerie atmosphere that the reader can see and hear.
          <small>Skill: descriptive imagery</small>
        </aside>
      </div>
      <!-- LINE 3 -->
      <div class="line scene">
        <div class="text">
          <p>A <mark>cold draft</mark> seeped in through an open window, making her shiver. She glanced around, suddenly aware of how <mark>empty</mark> the building was.</p>
        </div>
        <aside class="bubble scene-b">
          <span class="tag scene">Scene</span>
          Sensory details (temperature, touch, space) help readers feel the setting and anticipate danger.
          <small>Skill: multi-sensory detail</small>
        </aside>
      </div>
      <!-- LINE 4 -->
      <div class="line suspense">
        <div class="text">
          <p>Just as she reached for the library door, a <mark>loud crash</mark> shattered the silence.</p>
        </div>
        <aside class="bubble suspense-b">
          <span class="tag suspense">Suspense</span>
          A sudden, disruptive sound acts as a turning point and spikes tension.
          <small>Skill: inciting incident</small>
        </aside>
      </div>
      <!-- LINE 5 -->
      <div class="line suspense">
        <div class="text">
          <p>Her heart <mark>leapt</mark> as she froze, gripping her schoolbag tightly. The sound had come from <mark>inside the library</mark>. Earlier, <mark>Inathi</mark> and <mark>Kamva</mark> had been studying at the back table.</p>
        </div>
        <aside class="bubble suspense-b">
          <span class="tag suspense">Suspense</span>
          Strong verbs (leapt, froze) + precise location focus the reader’s fear and curiosity.
          <small>Skill: emotional beat</small>
        </aside>
      </div>
      <!-- LINE 6 -->
      <div class="line lang">
        <div class="text">
          <p>Slowly, she pushed the door open. The air <mark>smelled of dust and old books</mark>.</p>
        </div>
        <aside class="bubble lang-b">
          <span class="tag lang">Language</span>
          Smell adds depth to the scene and grounds the action in a real place.
          <small>Skill: sensory layering</small>
        </aside>
      </div>
      <!-- LINE 7 -->
      <div class="line seq">
        <div class="text">
          <p>A chair lay <mark>overturned</mark> in the corner, and in the dim light, she thought she saw <mark>Lincoln’s silhouette</mark> move—maybe <mark>Ukho</mark> or <mark>Caleb</mark>.</p>
        </div>
        <aside class="bubble seq-b">
          <span class="tag seq">Sequence</span>
          Visual clue → uncertainty → potential reveal. Ends on a mini cliffhanger to propel the next scene.
          <small>Skill: sequencing & cliffhanger</small>
        </aside>
      </div>
    </section>
  </div>

  <!-- Snake Modal -->
  <dialog id="snakeModal" aria-hidden="true">
    <div class="modal-wrap">
      <div>
        <div class="hud">
          <span class="pill">Score: <strong id="score">0</strong></span>
          <span class="pill">Mode: <strong id="mode">3D</strong> <span class="legend-chip"><i class="i-green"></i><i class="i-gold"></i><i class="i-red"></i><i class="i-blue"></i></span></span>
          <div class="modal-actions">
            <button id="backToStory" class="ghost">Back to Story</button>
            <button id="startGame">Start</button>
          </div>
        </div>
        <div class="game-surface" id="gameSurface">
          <canvas id="game3d" width="800" height="480"></canvas>
          <canvas id="game2d" width="800" height="480" style="display:none"></canvas>

          <!-- Milestone reminder overlay -->
          <div id="reminder" class="reminder" aria-live="polite">
            <div class="reminder-card">
              <h3 class="neon">Writer’s Toolkit Reminder</h3>
              <p id="reminderMsg">Sensory details: use sight, sound, smell, taste, touch.</p>
              <button id="reminderOk" class="ok">OK, got it!</button>
            </div>
          </div>
        </div>

        <!-- Non-blocking placement below game for tablets -->
        <div class="side" aria-label="On-screen touch controls">
          <div class="bar"></div>
          <div style="text-align:center; font-size:12px; color:var(--muted)">Touch Controls</div>
          <div class="ctrl-grid" role="group" aria-label="Directional controls">
            <div class="row-gap"></div>
            <button class="ctrl-btn" data-dir="up">▲</button>
            <div class="row-gap"></div>
            <button class="ctrl-btn" data-dir="left">◀</button>
            <button class="ctrl-btn" data-dir="down">▼</button>
            <button class="ctrl-btn" data-dir="right">▶</button>
          </div>
        </div>
      </div>

      <!-- Sidebar info -->
      <aside class="side">
        <div class="neon">Neon Snake (🇿🇦 colours)</div>
        <small class="legend-chip"><i class="i-green"></i> Body · <i class="i-gold"></i> Fruit · <i class="i-red"></i> Danger · <i class="i-blue"></i> Grid</small>
        <p style="color:var(--muted); font-size:13px; margin:0">Tip: Use the arrows or swipe. Every 3 points you’ll get a writing reminder.</p>
        <div class="bar"></div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button id="toggle2D" class="secondary">Toggle 2D / 3D</button>
          <button id="restart" class="secondary">Restart</button>
        </div>
      </aside>
    </div>
  </dialog>

<script>
/* ================== Story annotations ================== */
const story = document.getElementById('story');
const toggleAllBtn = document.getElementById('toggleAll');
story.classList.add('hidden-annotations');
toggleAllBtn.textContent = 'Show Annotations';
toggleAllBtn.setAttribute('aria-pressed','false');
toggleAllBtn.addEventListener('click', () => {
  const nowHidden = story.classList.toggle('hidden-annotations');
  toggleAllBtn.textContent = nowHidden ? 'Show Annotations' : 'Hide Annotations';
  toggleAllBtn.setAttribute('aria-pressed', String(!nowHidden));
});

/* ================== Hidden Snake Modal ================== */
const flagCta = document.getElementById('flagCta');
const snakeModal = document.getElementById('snakeModal');
const startBtn = document.getElementById('startGame');
const backBtn = document.getElementById('backToStory');
const toggle2DBtn = document.getElementById('toggle2D');
const restartBtn = document.getElementById('restart');

flagCta.addEventListener('click', () => {
  snakeModal.showModal();
  snakeModal.setAttribute('aria-hidden','false');
});
flagCta.addEventListener('keydown', e => {
  if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flagCta.click(); }
});

backBtn.addEventListener('click', () => {
  snakeModal.close();
  snakeModal.setAttribute('aria-hidden','true');
  stopGame();
});

/* ================== Snake Game (3D-ish with 2D fallback) ================== */
const c3d = document.getElementById('game3d');
const c2d = document.getElementById('game2d');
const sEl = document.getElementById('score');
const modeEl = document.getElementById('mode');
const surface = document.getElementById('gameSurface');

let use2D = false;
let raf = null;
let tickTimer = null;

const grid = { cols: 24, rows: 14, cell: 32 }; // 24*32=768 width inside 800 canvas
const world = { w: grid.cols*grid.cell, h: grid.rows*grid.cell };
c3d.width = c2d.width = world.w;
c3d.height = c2d.height = world.h;

const neon = {
  grid: '#1f5fff',
  fruit: ['#ffb612','#ffd36b'],
  body: ['#00e676','#00c853'],
  head: ['#00ffa3','#00c2a8'],
  danger: '#ff4d4d',
  bgTop: '#061228',
  bgBot: '#0e1324'
};

// game state
let snake, dir, nextDir, fruit, score, speedMs, alive, paused;

function reset(){
  snake = [{x:12,y:7},{x:11,y:7},{x:10,y:7}];
  dir = {x:1,y:0}; nextDir = {x:1,y:0};
  fruit = spawnFruit();
  score = 0; sEl.textContent = '0';
  speedMs = 140; alive = true; paused = false;
  milestoneGate = 0; // track last milestone multiple of 3 handled
}

function spawnFruit(){
  while(true){
    const f = { x: Math.floor(Math.random()*grid.cols), y: Math.floor(Math.random()*grid.rows) };
    if(!snake.some(s=>s.x===f.x && s.y===f.y)) return f;
  }
}

function setDir(nx,ny){
  // prevent reverse into neck
  if (snake.length > 1 && snake[0].x + nx === snake[1].x && snake[0].y + ny === snake[1].y) return;
  nextDir = {x:nx, y:ny};
}

function logic(){
  if(!alive || paused) return;
  dir = nextDir;
  const head = { x: (snake[0].x + dir.x + grid.cols) % grid.cols,
                 y: (snake[0].y + dir.y + grid.rows) % grid.rows };
  // self hit?
  if(snake.some(s=>s.x===head.x && s.y===head.y)){
    alive = false;
  } else {
    snake.unshift(head);
    if(head.x===fruit.x && head.y===fruit.y){
      score++; sEl.textContent = String(score);
      fruit = spawnFruit();
      if(score % 3 === 0) showMilestone(); // <<< every 3 points
      // increase speed a touch
      speedMs = Math.max(70, speedMs - 4);
    } else {
      snake.pop();
    }
  }
}

function draw2D(){
  const ctx = c2d.getContext('2d');
  ctx.clearRect(0,0,world.w,world.h);
  const grad = ctx.createLinearGradient(0,0,0,world.h);
  grad.addColorStop(0, neon.bgTop); grad.addColorStop(1, neon.bgBot);
  ctx.fillStyle = grad; ctx.fillRect(0,0,world.w,world.h);

  // grid
  ctx.globalAlpha = .25;
  ctx.strokeStyle = neon.grid; ctx.lineWidth = 1;
  for(let x=0; x<=grid.cols; x++){ ctx.beginPath(); ctx.moveTo(x*grid.cell,0); ctx.lineTo(x*grid.cell,world.h); ctx.stroke(); }
  for(let y=0; y<=grid.rows; y++){ ctx.beginPath(); ctx.moveTo(0,y*grid.cell); ctx.lineTo(world.w,y*grid.cell); ctx.stroke(); }
  ctx.globalAlpha = 1;

  // fruit (glow)
  const fx = fruit.x*grid.cell + grid.cell/2, fy = fruit.y*grid.cell + grid.cell/2;
  const rg = ctx.createRadialGradient(fx,fy,4, fx,fy,18);
  rg.addColorStop(0, neon.fruit[0]); rg.addColorStop(1, 'transparent');
  ctx.fillStyle = rg; ctx.beginPath(); ctx.arc(fx,fy,18,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = neon.fruit[1]; ctx.beginPath(); ctx.arc(fx,fy,8,0,Math.PI*2); ctx.fill();

  // snake
  snake.forEach((seg,i)=>{
    const x = seg.x*grid.cell, y = seg.y*grid.cell;
    ctx.fillStyle = i===0 ? neon.head[0] : neon.body[0];
    ctx.fillRect(x+4,y+4, grid.cell-8, grid.cell-8);
    ctx.strokeStyle = i===0 ? neon.head[1] : neon.body[1];
    ctx.strokeRect(x+4,y+4, grid.cell-8, grid.cell-8);
  });

  if(!alive){
    ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(0,0,world.w,world.h);
    ctx.fillStyle = neon.danger; ctx.font = 'bold 32px system-ui';
    ctx.textAlign='center'; ctx.fillText('Game Over – Restart?', world.w/2, world.h/2);
  }
}

function draw3D(){
  // “Fake 3D”: simple isometric skew with perspective scale per row
  const ctx = c3d.getContext('2d');
  ctx.clearRect(0,0,world.w,world.h);
  const grad = ctx.createLinearGradient(0,0,0,world.h);
  grad.addColorStop(0, '#001b2e'); grad.addColorStop(1, neon.bgBot);
  ctx.fillStyle = grad; ctx.fillRect(0,0,world.w,world.h);

  // floor lines
  ctx.strokeStyle = 'rgba(0,160,255,.25)'; ctx.lineWidth = 1;
  for(let y=0; y<=grid.rows; y++){
    const scale = 1 + (y - grid.rows/2)*0.02;
    ctx.globalAlpha = .9 - Math.abs(y-grid.rows/2)*0.05;
    ctx.beginPath();
    ctx.moveTo(0, y*grid.cell*scale);
    ctx.lineTo(world.w, y*grid.cell*scale);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  const drawBlock = (gx,gy,colorEdge,colorFill,isHead=false)=>{
    const scale = 1 + (gy - grid.rows/2)*0.06;
    const x = gx*grid.cell, y = gy*grid.cell*scale;
    const w = grid.cell, h = grid.cell*scale;
    ctx.fillStyle = colorFill;
    ctx.strokeStyle = colorEdge;
    ctx.lineWidth = 2;
    // top
    ctx.beginPath();
    ctx.roundRect(x+3, y+3, w-6, h-6, 6);
    ctx.fill();
    ctx.stroke();
    if(isHead){
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(x+w/2, y+6); ctx.lineTo(x+w/2, y+h-6); ctx.stroke();
    }
  };

  // fruit
  drawBlock(fruit.x, fruit.y, neon.fruit[0], 'rgba(255,182,18,.85)');
  // snake
  snake.forEach((seg,i)=>{
    drawBlock(seg.x, seg.y, i===0? neon.head[1]: neon.body[1], i===0?'rgba(0,255,163,.88)':'rgba(0,230,118,.78)', i===0);
  });

  if(!alive){
    ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(0,0,world.w,world.h);
    ctx.fillStyle = neon.danger; ctx.font = 'bold 32px system-ui';
    ctx.textAlign='center'; ctx.fillText('Game Over – Restart?', world.w/2, world.h/2);
  }
}

function frame(){
  if(use2D){ draw2D(); } else { draw3D(); }
  raf = requestAnimationFrame(frame);
}

function loop(){
  tickTimer = setInterval(()=>{ logic(); }, speedMs);
}

function stopGame(){
  if(raf) cancelAnimationFrame(raf);
  if(tickTimer) clearInterval(tickTimer);
  raf = tickTimer = null;
}

startBtn.addEventListener('click', ()=>{
  stopGame();
  reset();
  modeEl.textContent = use2D ? '2D' : '3D';
  frame();
  loop();
});

restartBtn.addEventListener('click', ()=>{ startBtn.click(); });

toggle2DBtn.addEventListener('click', ()=>{
  use2D = !use2D;
  modeEl.textContent = use2D ? '2D' : '3D';
});

/* Touch + Keyboard controls (no overlay on tablet) */
document.querySelectorAll('.ctrl-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const d = btn.getAttribute('data-dir');
    if(d==='up') setDir(0,-1);
    if(d==='down') setDir(0,1);
    if(d==='left') setDir(-1,0);
    if(d==='right') setDir(1,0);
  });
});

let touchStart=null;
surface.addEventListener('touchstart', e=>{ touchStart = e.changedTouches[0]; }, {passive:true});
surface.addEventListener('touchend', e=>{
  if(!touchStart) return;
  const dx = e.changedTouches[0].clientX - touchStart.clientX;
  const dy = e.changedTouches[0].clientY - touchStart.clientY;
  if(Math.abs(dx) > Math.abs(dy)){
    setDir(dx>0?1:-1,0);
  } else {
    setDir(0, dy>0?1:-1);
  }
  touchStart=null;
}, {passive:true});

window.addEventListener('keydown', e=>{
  if(e.key==='ArrowUp') setDir(0,-1);
  if(e.key==='ArrowDown') setDir(0,1);
  if(e.key==='ArrowLeft') setDir(-1,0);
  if(e.key==='ArrowRight') setDir(1,0);
});

/* ================== Milestone reminders (every 3 points) ================== */
const reminder = document.getElementById('reminder');
const reminderMsg = document.getElementById('reminderMsg');
const reminderOk = document.getElementById('reminderOk');

const tips = [
  'Sensory details: show sight, sound, smell, taste, touch.',
  'Use strong verbs to boost suspense (crept, snapped, thudded).',
  'Vary sentence length for rhythm and tension.',
  'Set the scene with time + place + mood.',
  'Use figurative language: simile, metaphor, personification.',
  'Zoom in on a telling detail (a trembling hand, a flickering light).',
  'Sequence clearly: first → then → next → finally.',
  'Dialogue can reveal character under pressure.',
  'End paragraphs on mini-cliffhangers.'
];
let milestoneGate = 0;

function showMilestone(){
  // Prevent re-trigger at same score multiple times in the same tick
  if(score === milestoneGate) return;
  milestoneGate = score;
  paused = true;
  reminderMsg.textContent = tips[(score/3 - 1) % tips.length];
  reminder.style.display = 'flex';
}
reminderOk.addEventListener('click', ()=>{
  reminder.style.display = 'none';
  paused = false;
});

/* ================== Test harnesses ================== */
function runAnnotationTests(){
  const results = [];
  // initial state hidden
  results.push({test:'story initially hidden', pass: story.classList.contains('hidden-annotations')});
  // show
  toggleAllBtn.click();
  results.push({test:'after 1st click visible', pass: !story.classList.contains('hidden-annotations')});
  // hide
  toggleAllBtn.click();
  results.push({test:'after 2nd click hidden', pass: story.classList.contains('hidden-annotations')});
  console.table(results); return results.every(r=>r.pass);
}

/* Snake logic tests (no rendering needed) */
function runSnakeTests(){
  reset();
  // eat 3 fruits → milestone
  score = 2; // just before 3
  milestoneGate = 0;
  score++; // becomes 3
  showMilestone();
  const t1 = paused && milestoneGate===3 && reminder.style.display==='flex';

  // dismiss and continue
  reminderOk.click();
  const t2 = !paused && reminder.style.display==='none';

  // next milestones at 6 and 9
  score = 5; showMilestone(); // should NOT show because not divisible by 3
  const t3 = milestoneGate===3; // unchanged

  score = 6; showMilestone();
  const t4 = milestoneGate===6 && reminder.style.display==='flex';

  console.table([
    {test:'milestone at 3 triggers', pass:t1},
    {test:'resume after OK', pass:t2},
    {test:'no trigger at 5', pass:t3},
    {test:'trigger at 6', pass:t4},
  ]);
  return t1 && t2 && t3 && t4;
}

/* Expose tests for you in console */
window.runAnnotationTests = runAnnotationTests;
window.runSnakeTests = runSnakeTests;

/* ================== Heritage Day note ================== */
console.info('Have a wonderful Heritage Day! Celebrate SA’s rich diversity. 🇿🇦');

</script>
</body>
</html>
